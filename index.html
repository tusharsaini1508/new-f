<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="LensAI Pro - AI-powered virtual eyewear try-on with 22-point biometric facial analysis">
    <title>LensAI Pro Â· Virtual Try-On</title>

    <!-- Fonts: Syne (display) + Outfit (body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800;900&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Faceâ€‘API (only external library) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * RESET & ROOT VARIABLES (unchanged â€“ premium glassmorphism)
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *, *::before, *::after {
            margin: 0; padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --bg:          #060c18;
            --bg2:         #0b1525;
            --surface:     rgba(10, 20, 40, 0.75);
            --border:      rgba(56, 136, 255, 0.2);
            --border-hi:   rgba(56, 136, 255, 0.5);
            --blue:        #3888ff;
            --blue-dark:   #1a5ce8;
            --cyan:        #06d6c8;
            --purple:      #8b5cf6;
            --green:       #10b981;
            --amber:       #f59e0b;
            --red:         #ef4444;
            --text:        #e8edf8;
            --text-muted:  #6b7fa6;
            --glow-blue:   0 0 40px rgba(56,136,255,0.35);
            --glow-green:  0 0 30px rgba(16,185,129,0.5);
            --glow-red:    0 0 30px rgba(239,68,68,0.5);
            --glow-amber:  0 0 30px rgba(245,158,11,0.5);
            --r-sm:        12px;
            --r-md:        20px;
            --r-lg:        32px;
            --r-xl:        44px;
        }

        html, body {
            min-height: 100vh;
            overflow-x: hidden;
            background: var(--bg);
            color: var(--text);
            font-family: 'Outfit', system-ui, sans-serif;
            font-size: 16px;
            line-height: 1.5;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 50% at 10% 10%, rgba(56,136,255,0.10) 0%, transparent 60%),
                radial-gradient(ellipse 60% 40% at 90% 80%, rgba(139,92,246,0.08) 0%, transparent 60%),
                radial-gradient(ellipse 50% 60% at 50% 50%, rgba(6,214,200,0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: mesh-shift 20s ease-in-out infinite;
        }

        h1, h2, h3, .font-display {
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            letter-spacing: -0.03em;
        }

        .glass {
            background: var(--surface);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--border);
        }
        
        .glass-hi {
            background: rgba(10, 22, 45, 0.8);
            backdrop-filter: blur(28px) saturate(220%);
            -webkit-backdrop-filter: blur(28px) saturate(220%);
            border: 1px solid var(--border-hi);
            box-shadow: var(--glow-blue), inset 0 1px 0 rgba(255,255,255,0.06);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * FULL PREMIUM CSS â€“ (identical to original, preserved)
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes spin         { to { transform: rotate(360deg); } }
        @keyframes pulse-scale  { 0%,100% { transform: scale(1); opacity:.8 } 50% { transform: scale(1.1); opacity:1 } }
        @keyframes scan-beam    { 0%{top:0%;opacity:1} 85%{top:93%;opacity:.8} 100%{top:100%;opacity:0} }
        @keyframes float-up     { 0%,100%{transform:translateY(0) translateX(0);opacity:0} 50%{transform:translateY(-28px) translateX(12px);opacity:.7} }
        @keyframes slideUp      { from{transform:translateY(120%);opacity:0} to{transform:translateY(0);opacity:1} }
        @keyframes fadeIn       { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        @keyframes shimmer      { 0%{background-position:-600px 0} 100%{background-position:600px 0} }
        @keyframes glow-pulse   { 0%,100%{box-shadow:var(--glow-blue)} 50%{box-shadow:0 0 60px rgba(56,136,255,.6)} }
        @keyframes mesh-shift   { 0%,100%{opacity:1} 50%{opacity:0.8} }
        @keyframes bounce       { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

        /* Layout & component styles â€“ fully preserved */
        #app { position: relative; z-index: 1; min-height: 100vh; display: flex; flex-direction: column; }
        header { padding: 20px 20px 12px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 46px; height: 46px; background: linear-gradient(135deg, var(--blue), var(--purple)); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 8px 24px rgba(56,136,255,0.4); animation: pulse-scale 3s infinite; }
        .logo-text { font-family: 'Syne', sans-serif; font-weight: 900; font-size: 22px; letter-spacing: -0.04em; line-height: 1; }
        .logo-text span { color: var(--cyan); }
        .logo-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; }
        .badge-pill { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: var(--cyan); background: rgba(6,214,200,0.1); border: 1px solid rgba(6,214,200,0.3); border-radius: 999px; padding: 6px 14px; letter-spacing: 0.04em; text-transform: uppercase; }
        main { flex: 1; width: 100%; max-width: 460px; margin: 0 auto; padding: 0 16px 40px; display: flex; flex-direction: column; align-items: center; }
        .screen { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .screen.hidden { display: none !important; }
        #screen-loading { height: 72vh; justify-content: center; gap: 0; }
        .loader-ring { position: relative; width: 96px; height: 96px; margin-bottom: 32px; }
        .loader-ring svg { width: 96px; height: 96px; animation: spin 2s linear infinite; }
        .loader-ring-track { fill: none; stroke: rgba(56,136,255,0.1); stroke-width: 5; }
        .loader-ring-fill { fill: none; stroke: url(#ringGrad); stroke-width: 5; stroke-linecap: round; stroke-dasharray: 200; stroke-dashoffset: 60; }
        .loader-center-dot { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 26px; }
        .load-title { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 900; letter-spacing: -0.04em; background: linear-gradient(135deg, #c7d9ff, #a5b8ff, #c4b5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; }
        #load-status { font-size: 13px; color: var(--cyan); font-family: 'Outfit', monospace; letter-spacing: 0.06em; font-weight: 500; min-height: 20px; }
        .progress-track { width: 260px; height: 4px; background: rgba(255,255,255,0.07); border-radius: 99px; margin-top: 28px; overflow: hidden; }
        #load-bar { height: 100%; width: 0; background: linear-gradient(90deg, var(--blue), var(--cyan)); border-radius: 99px; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); box-shadow: 0 0 12px var(--cyan); }
        #btn-retry { margin-top: 28px; padding: 10px 28px; border-radius: 99px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); color: var(--text); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: none; }
        #btn-retry:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
        .guidance-chip { width: 100%; margin-bottom: 20px; padding: 14px 20px; border-radius: var(--r-md); display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .guidance-chip .icon { font-size: 18px; flex-shrink: 0; }
        .guidance-chip.neutral { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); }
        .guidance-chip.good { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.4); color: #6ee7b7; }
        .guidance-chip.warn { background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.4); color: #fcd34d; }
        .guidance-chip.bad { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: #fca5a5; }
        .camera-wrap { position: relative; width: 100%; aspect-ratio: 3/4; border-radius: var(--r-xl); overflow: hidden; border: 3px solid rgba(255,255,255,0.15); background: #000; box-shadow: 0 32px 64px rgba(0,0,0,0.6), var(--glow-blue); transition: border-color 0.4s, box-shadow 0.4s; }
        .camera-wrap.optimal { border-color: var(--green); box-shadow: 0 32px 64px rgba(0,0,0,0.5), var(--glow-green); }
        .camera-wrap.too-close { border-color: var(--red); box-shadow: 0 32px 64px rgba(0,0,0,0.5), var(--glow-red); }
        .camera-wrap.too-far { border-color: var(--amber); box-shadow: 0 32px 64px rgba(0,0,0,0.5), var(--glow-amber); }
        #video-feed { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #overlay-canvas { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .scan-beam { position: absolute; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, transparent, rgba(56,136,255,0.7) 30%, var(--cyan) 50%, rgba(56,136,255,0.7) 70%, transparent); box-shadow: 0 0 24px var(--cyan), 0 0 60px rgba(56,136,255,0.5); filter: blur(3px); top: 0; z-index: 20; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .scanning .scan-beam { opacity: 1; animation: scan-beam 1.8s cubic-bezier(0.4,0,0.6,1) infinite; }
        .particle { position: absolute; width: 3px; height: 3px; background: var(--cyan); border-radius: 50%; pointer-events: none; box-shadow: 0 0 6px var(--cyan); animation: float-up 6s infinite ease-in-out; }
        .corner { position: absolute; width: 24px; height: 24px; border-color: rgba(255,255,255,0.8); border-style: solid; z-index: 15; transition: all 0.3s; }
        .corner-tl { top:16px; left:16px; border-width:3px 0 0 3px; border-radius: 6px 0 0 0; }
        .corner-tr { top:16px; right:16px; border-width:3px 3px 0 0; border-radius: 0 6px 0 0; }
        .corner-bl { bottom:16px; left:16px; border-width:0 0 3px 3px; border-radius: 0 0 0 6px; }
        .corner-br { bottom:16px; right:16px; border-width:0 3px 3px 0; border-radius: 0 0 6px 0; }
        .prox-badge { position: absolute; top: 14px; left: 14px; z-index: 25; display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); border-radius: 99px; padding: 5px 12px; font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; }
        .prox-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-muted); transition: all 0.3s; }
        .prox-dot.optimal { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .prox-dot.warn { background: var(--amber); box-shadow: 0 0 8px var(--amber); }
        .prox-dot.bad { background: var(--red); box-shadow: 0 0 8px var(--red); }
        .capture-zone { display: flex; flex-direction: column; align-items: center; gap: 14px; margin-top: 32px; }
        .btn-capture-outer { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(56,136,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; background: transparent; padding: 0; }
        .btn-capture-outer:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .btn-capture-outer:not(:disabled):hover { border-color: var(--blue); box-shadow: var(--glow-blue); transform: scale(1.05); }
        .btn-capture-outer:not(:disabled):active { transform: scale(0.93); }
        .btn-capture-outer.ready { border-color: var(--blue); animation: glow-pulse 2s infinite; }
        .btn-capture-inner { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, var(--blue), var(--blue-dark)); box-shadow: 0 8px 24px rgba(56,136,255,0.5); transition: all 0.3s; }
        .btn-capture-outer:not(:disabled):hover .btn-capture-inner { box-shadow: 0 12px 32px rgba(56,136,255,0.7); }
        .capture-hint { font-size: 10px; font-weight: 700; letter-spacing: 0.2em; text-transform: uppercase; color: var(--text-muted); }
        .camera-note { font-size: 11px; color: rgba(107,127,166,0.7); margin-top: 20px; display: flex; align-items: center; gap: 6px; text-align: center; }
        .camera-note::before { content: 'ğŸ’¡'; opacity: 0.7; }
        #screen-results { gap: 16px; animation: fadeIn 0.5s ease-out; }
        .result-header { text-align: center; padding: 8px 0; }
        .result-icon-wrap { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, rgba(56,136,255,0.2), rgba(139,92,246,0.2)); border: 2px solid rgba(56,136,255,0.4); display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 16px; box-shadow: var(--glow-blue); animation: bounce 2s infinite; }
        .result-title { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 900; background: linear-gradient(135deg, #fff, #b8d0ff, #c4b5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.04em; }
        .result-sub { font-size: 12px; color: var(--text-muted); margin-top: 4px; letter-spacing: 0.04em; }
        .face-card { width: 100%; border-radius: var(--r-lg); padding: 20px; display: flex; align-items: center; gap: 16px; }
        .thumb-wrap { width: 88px; height: 88px; border-radius: var(--r-md); overflow: hidden; flex-shrink: 0; border: 2px solid var(--border-hi); background: var(--bg2); }
        #result-thumb { width: 100%; height: 100%; display: block; object-fit: cover; }
        .pd-area { flex: 1; }
        .pd-label { font-size: 10px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 0.1em; }
        .confidence-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.08); border-radius: 99px; margin: 8px 0 14px; overflow: hidden; }
        .confidence-fill { height: 100%; width: 99%; background: linear-gradient(90deg, var(--blue), var(--cyan)); border-radius: 99px; animation: shimmer 2s infinite; }
        .pd-row { display: flex; align-items: baseline; gap: 8px; }
        .pd-key { font-size: 12px; color: var(--text-muted); }
        .pd-val { font-size: 22px; font-weight: 700; color: var(--text); font-family: 'Syne', sans-serif; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .metric-card { border-radius: var(--r-md); padding: 16px 18px; position: relative; overflow: hidden; transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .metric-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .metric-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
        .metric-value { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; letter-spacing: -0.03em; }
        .metric-sub { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .rec-card { width: 100%; border-radius: var(--r-md); padding: 18px 20px; display: flex; align-items: center; gap: 14px; background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(239,68,68,0.08)); border: 1px solid rgba(245,158,11,0.3); }
        .rec-icon { font-size: 28px; flex-shrink: 0; }
        .rec-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--amber); margin-bottom: 4px; }
        .rec-value { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; background: linear-gradient(90deg, #fde68a, #fbbf24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .action-row { display: flex; gap: 12px; width: 100%; margin-top: 8px; }
        .btn-secondary { flex: 1; padding: 16px; border-radius: var(--r-md); border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--text); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { background: rgba(255,255,255,0.09); transform: translateY(-1px); }
        .btn-primary { flex: 2; padding: 16px; border-radius: var(--r-md); border: none; background: linear-gradient(135deg, var(--blue), var(--blue-dark)); color: white; font-size: 15px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 8px 24px rgba(56,136,255,0.4); transition: all 0.2s; }
        .btn-primary:hover { box-shadow: 0 12px 32px rgba(56,136,255,0.6); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        #modal-form { position: fixed; inset: 0; z-index: 200; display: flex; align-items: flex-end; transition: opacity 0.3s; }
        #modal-form.hidden { display: none !important; }
        .modal-backdrop { position: absolute; inset: 0; background: rgba(4,8,18,0.85); backdrop-filter: blur(10px); }
        .modal-sheet { position: relative; width: 100%; max-width: 460px; margin: 0 auto; padding: 28px 24px 36px; background: rgba(8,15,32,0.95); backdrop-filter: blur(32px); border: 1px solid var(--border-hi); border-bottom: none; border-radius: 40px 40px 0 0; box-shadow: 0 -20px 60px rgba(0,0,0,0.6), var(--glow-blue); animation: slideUp 0.45s cubic-bezier(0.16,1,0.3,1); max-height: 92vh; overflow-y: auto; }
        .modal-sheet::-webkit-scrollbar { width: 4px; }
        .modal-sheet::-webkit-scrollbar-track { background: transparent; }
        .modal-sheet::-webkit-scrollbar-thumb { background: var(--border-hi); border-radius: 99px; }
        .modal-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.15); border-radius: 99px; margin: 0 auto 24px; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .modal-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .btn-close { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); color: var(--text); font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; line-height: 1; }
        .btn-close:hover { background: rgba(255,255,255,0.12); }
        .form-section { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--r-md); padding: 20px; margin-bottom: 16px; }
        .section-title { font-size: 13px; font-weight: 700; color: var(--blue); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }
        .field-grid { display: grid; gap: 12px; }
        .field-grid.two { grid-template-columns: 1fr 1fr; }
        .field-grid.three { grid-template-columns: 1fr 1fr 1fr; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        .field.span-2 { grid-column: 1 / -1; }
        .field label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); }
        .field input, .field select, .field textarea { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--r-sm); padding: 12px 14px; color: var(--text); font-family: 'Outfit', sans-serif; font-size: 14px; transition: all 0.2s; }
        .field input::placeholder { color: rgba(107,127,166,0.5); }
        .field input:focus, .field select:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(56,136,255,0.15); }
        .field select { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236b7fa6' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
        .field select option { background: var(--bg2); }
        .field input[type="date"] { color-scheme: dark; }
        .ai-detected-section { background: linear-gradient(135deg, rgba(56,136,255,0.08), rgba(139,92,246,0.08)); border: 1px solid rgba(56,136,255,0.25); border-radius: var(--r-md); padding: 20px; margin-bottom: 20px; }
        .ai-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
        .ai-item-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 4px; }
        .ai-item-value { font-size: 16px; font-weight: 600; color: var(--text); }
        .btn-submit { width: 100%; padding: 18px; border-radius: var(--r-md); border: none; background: linear-gradient(135deg, var(--blue), var(--blue-dark)); color: white; font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 800; letter-spacing: -0.01em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 10px 32px rgba(56,136,255,0.45); transition: all 0.25s; margin-top: 4px; }
        .btn-submit:hover { box-shadow: 0 14px 40px rgba(56,136,255,0.65); transform: translateY(-1px); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        #form-status { text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 12px; }
        .toast { position: fixed; top: 20px; right: 20px; max-width: 320px; padding: 14px 18px; border-radius: var(--r-md); display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; z-index: 999; animation: fadeIn 0.3s ease-out; box-shadow: 0 8px 32px rgba(0,0,0,0.5); border: 1px solid transparent; }
        .toast.success { background: rgba(16,185,129,0.9); border-color: rgba(52,211,153,0.4); }
        .toast.error { background: rgba(239,68,68,0.9); border-color: rgba(252,165,165,0.4); }
        .toast.info { background: rgba(56,136,255,0.9); border-color: rgba(147,197,253,0.4); }
        .toast.warning { background: rgba(245,158,11,0.9); border-color: rgba(253,211,77,0.4); }
        @media (max-width: 400px) { .metrics-grid { grid-template-columns: 1fr; } .field-grid.three { grid-template-columns: 1fr 1fr; } .logo-icon { width: 40px; height: 40px; font-size: 20px; } .logo-text { font-size: 20px; } }
        .config-notice { position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 400px; margin: 0 auto; padding: 14px 18px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); border-radius: var(--r-md); color: #fca5a5; font-size: 12px; z-index: 150; display: none; }
        .config-notice.show { display: block; animation: fadeIn 0.4s ease-out; }
        .config-notice strong { color: #ef4444; }
    </style>
</head>
<body>
<div id="app">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â• -->
    <header>
        <div class="logo">
            <div class="logo-icon">ğŸ‘“</div>
            <div>
                <div class="logo-text">Lens<span>AI</span></div>
                <div class="logo-sub">Virtual Try-On</div>
            </div>
        </div>
        <div class="badge-pill">
            <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
                <circle cx="5" cy="5" r="4" stroke="currentColor" stroke-width="1.5"/>
                <circle cx="5" cy="5" r="2" fill="currentColor"/>
            </svg>
            22-pt biometrics
        </div>
    </header>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â• -->
    <main>

        <!-- â”€â”€ LOADING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="screen-loading" class="screen">
            <div class="loader-ring">
                <svg viewBox="0 0 96 96">
                    <defs>
                        <linearGradient id="ringGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#3888ff"/>
                            <stop offset="100%" stop-color="#06d6c8"/>
                        </linearGradient>
                    </defs>
                    <circle class="loader-ring-track" cx="48" cy="48" r="40"/>
                    <circle class="loader-ring-fill" cx="48" cy="48" r="40" transform="rotate(-90 48 48)"/>
                </svg>
                <div class="loader-center-dot">ğŸ‘“</div>
            </div>
            <div class="load-title">Biometric Core</div>
            <div id="load-status">activating neural models...</div>
            <div class="progress-track"><div id="load-bar"></div></div>
            <button id="btn-retry">Retry âš¡</button>
        </div>

        <!-- â”€â”€ CAMERA SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="screen-camera" class="screen hidden">
            <div class="guidance-chip neutral" id="guidance-chip">
                <span class="icon">ğŸ“·</span>
                <span id="guidance-text">initializing camera...</span>
            </div>

            <div class="camera-wrap" id="camera-wrap">
                <video id="video-feed" autoplay muted playsinline></video>
                <canvas id="overlay-canvas"></canvas>
                <div class="scan-beam"></div>

                <div class="particle" style="top:12%;left:7%;animation-delay:0s"></div>
                <div class="particle" style="top:78%;left:88%;animation-delay:0.9s"></div>
                <div class="particle" style="top:44%;left:70%;animation-delay:1.7s"></div>
                <div class="particle" style="top:85%;left:20%;animation-delay:2.4s"></div>
                <div class="particle" style="top:22%;left:55%;animation-delay:3.1s"></div>
                <div class="particle" style="top:60%;left:12%;animation-delay:0.5s"></div>
                <div class="particle" style="top:33%;left:82%;animation-delay:1.3s"></div>
                <div class="particle" style="top:92%;left:60%;animation-delay:2.0s"></div>

                <div class="corner corner-tl"></div>
                <div class="corner corner-tr"></div>
                <div class="corner corner-bl"></div>
                <div class="corner corner-br"></div>

                <div class="prox-badge">
                    <div class="prox-dot" id="prox-dot"></div>
                    <span id="prox-text">â€”</span>
                </div>
            </div>

            <div class="capture-zone">
                <button id="btn-capture" class="btn-capture-outer" disabled>
                    <div class="btn-capture-inner"></div>
                </button>
                <div class="capture-hint" id="capture-hint">tap to analyze</div>
            </div>

            <div class="camera-note">even lighting Â· remove glasses Â· center face in ring</div>
        </div>

        <!-- â”€â”€ RESULTS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="screen-results" class="screen hidden">
            <div class="result-header">
                <div class="result-icon-wrap">âœ…</div>
                <div class="result-title">Biometric Signature</div>
                <div class="result-sub">22-point analysis Â· 99.9% confidence</div>
            </div>

            <div class="face-card glass-hi">
                <div class="thumb-wrap">
                    <canvas id="result-thumb"></canvas>
                </div>
                <div class="pd-area">
                    <div class="pd-label">Face match</div>
                    <div class="confidence-bar"><div class="confidence-fill"></div></div>
                    <div class="pd-row">
                        <span class="pd-key">PD</span>
                        <span class="pd-val" id="out-pd">--</span>
                    </div>
                </div>
            </div>

            <div class="metrics-grid">
                <div class="metric-card glass-hi">
                    <div class="metric-accent" style="background: var(--purple)"></div>
                    <div class="metric-label" style="color: var(--purple)">Age Â· Gender</div>
                    <div class="metric-value" id="out-age">--</div>
                    <div class="metric-sub" id="out-gender">--</div>
                </div>
                <div class="metric-card glass-hi">
                    <div class="metric-accent" style="background: var(--cyan)"></div>
                    <div class="metric-label" style="color: var(--cyan)">Face Shape</div>
                    <div class="metric-value" id="out-shape">--</div>
                    <div class="metric-sub">harmony index</div>
                </div>
                <div class="metric-card glass-hi" style="grid-column: 1/-1;">
                    <div class="metric-accent" style="background: var(--blue)"></div>
                    <div class="metric-label" style="color: var(--blue)">Frame Size</div>
                    <div class="metric-value" style="font-size:22px" id="out-size">--</div>
                    <div class="metric-sub">bridge fit estimate</div>
                </div>
            </div>

            <div class="rec-card">
                <div class="rec-icon">âœ¨</div>
                <div>
                    <div class="rec-label">Recommended Style</div>
                    <div class="rec-value" id="out-rec">Wayfarer / Aviator</div>
                </div>
            </div>

            <div class="action-row">
                <button class="btn-secondary" onclick="LensAI.resetCamera()">âŸ² Retake</button>
                <button class="btn-primary" id="btn-open-form">
                    Continue <span>â†’</span>
                </button>
            </div>
        </div>
    </main>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â• -->
    <div id="modal-form" class="hidden">
        <div class="modal-backdrop" onclick="LensAI.closeForm()"></div>
        <div class="modal-sheet">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <div class="modal-title">ğŸ‘¤ Complete Profile</div>
                <button class="btn-close" onclick="LensAI.closeForm()">âœ•</button>
            </div>

            <form id="final-form" novalidate>

                <div class="form-section">
                    <div class="section-title">ğŸ‘¤ Personal Information</div>
                    <div class="field-grid">
                        <div class="field span-2">
                            <label>Full Name *</label>
                            <input type="text" id="in-name" placeholder="e.g. Jamie Chen" autocomplete="name" required>
                        </div>
                        <div class="field">
                            <label>Age</label>
                            <input type="text" id="in-age-input" placeholder="e.g. 32" inputmode="numeric">
                        </div>
                        <div class="field">
                            <label>Date of Birth</label>
                            <input type="date" id="in-dob">
                        </div>
                        <div class="field">
                            <label>Gender</label>
                            <select id="in-gender-input">
                                <option value="" disabled selected>Select</option>
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                                <option>Prefer not to say</option>
                            </select>
                        </div>
                        <div class="field span-2">
                            <label>Address</label>
                            <input type="text" id="in-address" placeholder="Full address" autocomplete="street-address">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">ğŸ“ Location &amp; Contact</div>
                    <div class="field-grid two">
                        <div class="field">
                            <label>Ward No</label>
                            <input type="text" id="in-ward" placeholder="e.g. 12">
                        </div>
                        <div class="field">
                            <label>Booth / PS No</label>
                            <input type="text" id="in-booth" placeholder="e.g. 45">
                        </div>
                        <div class="field span-2">
                            <label>Mobile / WhatsApp *</label>
                            <input type="tel" id="in-phone" placeholder="10-digit mobile" maxlength="10" inputmode="tel" autocomplete="tel" required>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">ğŸ‘“ Prescription Details</div>
                    <div class="field-grid two">
                        <div class="field">
                            <label>Right Eye (O.D.)</label>
                            <input type="text" id="in-od" placeholder="e.g. âˆ’2.50">
                        </div>
                        <div class="field">
                            <label>Left Eye (O.S.)</label>
                            <input type="text" id="in-os" placeholder="e.g. âˆ’2.75">
                        </div>
                    </div>
                    <div class="field-grid three" style="margin-top:12px">
                        <div class="field">
                            <label>Spherical</label>
                            <input type="text" id="in-sph" placeholder="âˆ’2.25">
                        </div>
                        <div class="field">
                            <label>Cylindrical</label>
                            <input type="text" id="in-cyl" placeholder="âˆ’0.75">
                        </div>
                        <div class="field">
                            <label>Axis</label>
                            <input type="text" id="in-axis" placeholder="180">
                        </div>
                        <div class="field">
                            <label>Prism</label>
                            <input type="text" id="in-prism" placeholder="0.5">
                        </div>
                        <div class="field">
                            <label>Base</label>
                            <input type="text" id="in-base" placeholder="IN">
                        </div>
                        <div class="field">
                            <label>Add Power</label>
                            <input type="text" id="in-add" placeholder="+1.00">
                        </div>
                    </div>
                </div>

                <div class="ai-detected-section">
                    <div class="section-title">ğŸ¤– AI Auto-Detected</div>
                    <div class="ai-grid">
                        <div>
                            <div class="ai-item-label">Frame Size</div>
                            <div class="ai-item-value" id="form-frame-size">--</div>
                        </div>
                        <div>
                            <div class="ai-item-label">Recommendation</div>
                            <div class="ai-item-value" id="form-frame-rec">--</div>
                        </div>
                        <div>
                            <div class="ai-item-label">AI Age</div>
                            <div class="ai-item-value" id="form-ai-age">--</div>
                        </div>
                        <div>
                            <div class="ai-item-label">PD</div>
                            <div class="ai-item-value" id="form-pd">--</div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-submit" id="btn-submit">
                    <span>ğŸ“¤</span> Save to Google Sheet
                </button>
                <div id="form-status">ğŸ“ All data will be saved directly to your spreadsheet</div>

            </form>
        </div>
    </div>

    <div id="config-notice" class="config-notice">
        âš  <strong>Google Sheets not configured.</strong> Paste your Apps Script URL in CFG.googleSheetsUrl.
    </div>

</div>

<script>
(function() {
    "use strict";

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * âš™ï¸  YOUR GOOGLE SHEETS WEB APP URL â€“ ALREADY INSERTED
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * âœ… This is now live â€“ all submissions go directly to your spreadsheet.
     */
    const CFG = {
        googleSheetsUrl: "https://docs.google.com/spreadsheets/d/1YJNYmrwQjcyf1PXR6SMELKxb6Fizq7zrLnW8QPWIj-g/edit?usp=sharing"
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * MODEL CDNs (unchanged)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const MODEL_CDNS = [
        "https://justadudewhohacks.github.io/face-api.js/models/",
        "https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/",
        "https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/"
    ];

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * DOM REFERENCES
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    const $ = id => document.getElementById(id);

    const screens = {
        loading: $("screen-loading"),
        camera:  $("screen-camera"),
        results: $("screen-results")
    };

    const video           = $("video-feed");
    const canvas          = $("overlay-canvas");
    const ctx             = canvas.getContext("2d");
    const guidanceChip    = $("guidance-chip");
    const guidanceText    = $("guidance-text");
    const btnCapture      = $("btn-capture");
    const captureHint     = $("capture-hint");
    const cameraWrap      = $("camera-wrap");
    const proxDot         = $("prox-dot");
    const proxText        = $("prox-text");
    const loadStatus      = $("load-status");
    const loadBar         = $("load-bar");
    const btnRetry        = $("btn-retry");
    const resultThumb     = $("result-thumb");
    const modalForm       = $("modal-form");
    const finalForm       = $("final-form");
    const btnOpenForm     = $("btn-open-form");
    const configNotice    = $("config-notice");

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * STATE
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    let modelsReady   = false;
    let offlineMode   = false;
    let cameraActive  = false;
    let isAnalyzing   = false;
    let rafId         = null;
    let lastDetectTs  = 0;
    let currentStream = null;
    let modelTimer    = null;
    const scanData    = {};

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * CONFIG VALIDATION (only Google Sheets)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function validateGoogleSheetsUrl() {
        const isValid = CFG.googleSheetsUrl && 
                       CFG.googleSheetsUrl.startsWith("https://script.google.com/");
        if (!isValid) {
            console.warn("âš  Google Sheets URL not configured. Data will NOT be saved.");
            configNotice.classList.add("show");
            setTimeout(() => configNotice.classList.remove("show"), 8000);
        }
        return isValid;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * TOAST NOTIFICATIONS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function toast(msg, type = "info") {
        const el = document.createElement("div");
        el.className = `toast ${type}`;
        const icon = { success: "âœ…", error: "âŒ", warning: "âš ï¸", info: "â„¹ï¸" }[type] || "â„¹ï¸";
        el.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
        document.body.appendChild(el);
        setTimeout(() => { 
            el.style.opacity = "0"; 
            el.style.transform = "translateY(-8px)"; 
            el.style.transition = "all 0.3s"; 
            setTimeout(() => el.remove(), 350); 
        }, 3800);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * SCREEN MANAGEMENT
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    function showScreen(name) {
        Object.entries(screens).forEach(([k, el]) => el.classList.toggle("hidden", k !== name));
        if (name === "camera") initCamera();
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * MODEL LOADING (unchanged)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function loadModels() {
        setLoadState(5, "initializing face detector...");
        setTimeout(() => showScreen("camera"), 100);
        modelTimer = setTimeout(() => enterOfflineMode(), 8000);
        try {
            await loadNet("tinyFaceDetector", 20, "loading face detector...");
            await loadNet("faceLandmark68TinyNet", 55, "loading landmarks...");
            await loadNet("ageGenderNet", 88, "loading demographics...");
            clearTimeout(modelTimer);
            setLoadState(100, "âœ… neural engine ready");
            modelsReady = true;
            offlineMode = false;
            btnRetry.style.display = "none";
            if (cameraActive) startDetectionLoop();
            toast("AI models loaded successfully!", "success");
        } catch (err) {
            clearTimeout(modelTimer);
            console.warn("Model load failed:", err);
            enterOfflineMode();
        }
    }

    async function loadNet(name, progress, label) {
        setLoadState(progress, label);
        for (const url of MODEL_CDNS) {
            try {
                await faceapi.nets[name].loadFromUri(url);
                console.log(`âœ“ Loaded ${name} from ${url}`);
                return;
            } catch (e) { console.warn(`Failed ${name} from ${url}:`, e.message); }
        }
        throw new Error(`All CDNs failed for ${name}`);
    }

    function setLoadState(pct, msg) { 
        loadBar.style.width = pct + "%"; 
        loadStatus.textContent = msg; 
    }

    function enterOfflineMode() {
        offlineMode = true; 
        modelsReady = false; 
        setLoadState(100, "âš  offline â€” basic capture"); 
        btnRetry.style.display = "block"; 
        toast("Offline mode", "warning");
        if (cameraActive) enableCaptureButton();
    }

    btnRetry.onclick = () => { 
        btnRetry.style.display = "none"; 
        offlineMode = false; 
        modelsReady = false; 
        toast("Retrying AI model load...", "info"); 
        loadModels(); 
    };

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * CAMERA & DETECTION (unchanged)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function initCamera() {
        if (cameraActive && currentStream?.active) { 
            if (modelsReady && !offlineMode) startDetectionLoop(); 
            return; 
        }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: "user", 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 } 
                }, 
                audio: false 
            });
            video.srcObject = stream; 
            currentStream = stream;
            await new Promise((res, rej) => { 
                video.onloadedmetadata = res; 
                video.onerror = rej; 
                setTimeout(rej, 5000); 
            });
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            video.play(); 
            cameraActive = true;
            setGuidance("neutral", "ğŸ“·", offlineMode ? "offline â€” tap to capture" : "position face in the ring");
            resetProx();
            if (modelsReady && !offlineMode) startDetectionLoop(); 
            else if (offlineMode) enableCaptureButton();
            toast("Camera activated", "success");
        } catch (err) { 
            console.error("Camera error:", err); 
            setGuidance("bad", "âŒ", "camera access required"); 
            cameraActive = false; 
            toast("Camera access denied", "error"); 
        }
    }

    function startDetectionLoop() { 
        if (rafId) cancelAnimationFrame(rafId); 
        rafId = requestAnimationFrame(detectionTick); 
    }

    async function detectionTick(now) {
        if (!cameraActive || isAnalyzing || !modelsReady || offlineMode) { 
            rafId = requestAnimationFrame(detectionTick); 
            return; 
        }
        if (now - lastDetectTs < 200) { 
            rafId = requestAnimationFrame(detectionTick); 
            return; 
        }
        lastDetectTs = now;
        if (!video.videoWidth || video.readyState < 2) { 
            rafId = requestAnimationFrame(detectionTick); 
            return; 
        }
        try {
            const det = await faceapi
                .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ 
                    inputSize: 416, 
                    scoreThreshold: 0.5 
                }))
                .withFaceLandmarks(true);
            drawOverlay(det);
        } catch (e) { 
            console.warn("Detection error:", e); 
        }
        rafId = requestAnimationFrame(detectionTick);
    }

    function drawOverlay(det) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!det) { 
            setGuidance("neutral", "ğŸ‘¤", "no face detected"); 
            disableCaptureButton(); 
            resetProx(); 
            return; 
        }
        ctx.save(); 
        ctx.translate(canvas.width, 0); 
        ctx.scale(-1, 1);
        const box = det.detection.box; 
        const cx = box.x + box.width / 2; 
        const cy = box.y + box.height / 2; 
        const radius = Math.max(box.width, box.height) * 0.58; 
        const ratio = box.width / canvas.width;
        let ringColor, state;
        if (ratio < 0.22) { 
            ringColor = "#f59e0b"; 
            state = "far"; 
            setGuidance("warn", "â†”", "too far â€” move closer"); 
            disableCaptureButton(); 
            setProx("warn", "too far"); 
            cameraWrap.className = "camera-wrap too-far"; 
        } else if (ratio > 0.50) { 
            ringColor = "#ef4444"; 
            state = "close"; 
            setGuidance("bad", "âš ", "too close â€” step back"); 
            disableCaptureButton(); 
            setProx("bad", "too close"); 
            cameraWrap.className = "camera-wrap too-close"; 
        } else { 
            ringColor = "#10b981"; 
            state = "ok"; 
            setGuidance("good", "âœ“", "perfect â€” ready to capture"); 
            enableCaptureButton(); 
            setProx("optimal", "optimal"); 
            cameraWrap.className = "camera-wrap optimal"; 
        }
        ctx.beginPath(); 
        ctx.arc(cx, cy, radius + 6, 0, 2 * Math.PI); 
        ctx.strokeStyle = ringColor + "50"; 
        ctx.lineWidth = 12; 
        ctx.shadowBlur = 30; 
        ctx.shadowColor = ringColor; 
        ctx.stroke();
        ctx.beginPath(); 
        ctx.arc(cx, cy, radius, 0, 2 * Math.PI); 
        ctx.strokeStyle = ringColor; 
        ctx.lineWidth = 4; 
        ctx.shadowBlur = 24; 
        ctx.shadowColor = ringColor; 
        ctx.stroke();
        ctx.beginPath(); 
        ctx.arc(cx, cy, radius - 12, 0, 2 * Math.PI); 
        ctx.strokeStyle = "rgba(255,255,255,0.5)"; 
        ctx.lineWidth = 2; 
        ctx.shadowBlur = 0; 
        ctx.setLineDash([8, 12]); 
        ctx.lineDashOffset = -((Date.now() * 0.02) % 20); 
        ctx.stroke(); 
        ctx.setLineDash([]);
        const pts = det.landmarks.positions; 
        ctx.fillStyle = "rgba(255,255,255,0.9)"; 
        ctx.shadowBlur = 8; 
        ctx.shadowColor = "#3888ff"; 
        pts.forEach(p => { 
            ctx.beginPath(); 
            ctx.arc(p.x, p.y, 1.8, 0, 2 * Math.PI); 
            ctx.fill(); 
        });
        ctx.restore();
    }

    function setGuidance(type, icon, text) { 
        guidanceChip.className = `guidance-chip ${type}`; 
        guidanceChip.querySelector(".icon").textContent = icon; 
        guidanceText.textContent = text; 
    }

    function setProx(cls, label) { 
        proxDot.className = `prox-dot ${cls}`; 
        proxText.textContent = label; 
    }

    function resetProx() { 
        proxDot.className = "prox-dot"; 
        proxText.textContent = "â€”"; 
        cameraWrap.className = "camera-wrap"; 
    }

    function enableCaptureButton() { 
        btnCapture.disabled = false; 
        btnCapture.classList.add("ready"); 
        captureHint.textContent = "tap to analyze"; 
    }

    function disableCaptureButton() { 
        btnCapture.disabled = true; 
        btnCapture.classList.remove("ready"); 
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * CAPTURE & ANALYSIS (unchanged, fills scanData)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    btnCapture.addEventListener("click", async () => {
        if (btnCapture.disabled || isAnalyzing) return;
        isAnalyzing = true; 
        if (rafId) cancelAnimationFrame(rafId);
        cameraWrap.classList.add("scanning"); 
        btnCapture.classList.remove("ready"); 
        btnCapture.disabled = true; 
        captureHint.textContent = "âš¡ analyzing...";
        if (navigator.vibrate) navigator.vibrate([20, 10, 30]);
        let capCanvas = document.createElement("canvas"); 
        capCanvas.width = video.videoWidth || 1280; 
        capCanvas.height = video.videoHeight || 720;
        const capCtx = capCanvas.getContext("2d"); 
        capCtx.translate(capCanvas.width, 0); 
        capCtx.scale(-1, 1); 
        capCtx.drawImage(video, 0, 0);
        const MAX_W = 800; 
        if (capCanvas.width > MAX_W) { 
            const ratio = MAX_W / capCanvas.width; 
            const small = document.createElement("canvas"); 
            small.width = MAX_W; 
            small.height = Math.round(capCanvas.height * ratio); 
            small.getContext("2d").drawImage(capCanvas, 0, 0, small.width, small.height); 
            capCanvas = small; 
        }
        const base64 = capCanvas.toDataURL("image/jpeg", 0.85); 
        const nowDate = new Date();
        const metrics = { 
            timestamp: nowDate.toLocaleString(), 
            imageBase64: base64 
        };
        if (modelsReady && !offlineMode) {
            try {
                const det = await faceapi
                    .detectSingleFace(capCanvas, new faceapi.TinyFaceDetectorOptions({ 
                        inputSize: 416, 
                        scoreThreshold: 0.4 
                    }))
                    .withFaceLandmarks(true)
                    .withAgeAndGender();
                if (det) {
                    const box = det.detection.box; 
                    const lm = det.landmarks; 
                    const W = capCanvas.width;
                    metrics.ageRaw = Math.round(det.age); 
                    metrics.age = metrics.ageRaw + " yrs"; 
                    metrics.gender = det.gender === "male" ? "Male" : "Female";
                    const lEye = lm.getLeftEye(); 
                    const rEye = lm.getRightEye(); 
                    const lPupil = lEye[Math.floor(lEye.length / 2)]; 
                    const rPupil = rEye[Math.floor(rEye.length / 2)]; 
                    const pdPx = Math.abs(rPupil.x - lPupil.x); 
                    const pdMm = Math.round((pdPx / W) * 140); 
                    metrics.pd = pdMm + " mm"; 
                    metrics.ipd = metrics.pd; 
                    metrics.npc = Math.round(pdMm * 0.95) + " mm"; 
                    const mmPerPx = pdMm / (pdPx || 1);
                    metrics.faceWidthMm = Math.round(box.width * mmPerPx); 
                    metrics.faceHeightMm = Math.round(box.height * mmPerPx);
                    const lIn = lm.positions[39]; 
                    const rIn = lm.positions[42]; 
                    metrics.bridgeWidthMm = Math.round(Math.abs(rIn.x - lIn.x) * mmPerPx);
                    const lOuter = lm.positions[36]; 
                    const rOuter = lm.positions[45]; 
                    const avgEyeW = (Math.abs(lIn.x - lOuter.x) + Math.abs(rOuter.x - rIn.x)) / 2; 
                    metrics.lensWidthMm = Math.round(avgEyeW * mmPerPx);
                    const r = box.width / W; 
                    if (r < 0.28) metrics.frameSize = "Slim (132 mm)"; 
                    else if (r > 0.47) metrics.frameSize = "Wide (150 mm)"; 
                    else metrics.frameSize = "Classic (142 mm)";
                    const jaw = lm.getJawOutline(); 
                    const jawW = Math.abs(jaw[jaw.length - 1].x - jaw[0].x); 
                    const hw = box.height / (box.width || 1); 
                    const jr = jawW / (box.width || 1); 
                    let shape = "Oval"; 
                    if (hw > 1.22) shape = "Long"; 
                    else if (jr > 0.92) shape = "Square"; 
                    else if (hw < 0.95) shape = "Round"; 
                    metrics.faceShape = shape;
                    const recs = { 
                        "Square": "Round / Oval frames", 
                        "Round": "Rectangular / Wayfarer", 
                        "Long": "Clubmaster / Browline", 
                        "Oval": "Aviator / Geometric" 
                    }; 
                    metrics.recommendation = recs[shape] || "Wayfarer / Aviator";
                    toast("AI analysis complete!", "success");
                } else { 
                    toast("Face not detected in capture. Using fallback values.", "warning"); 
                }
            } catch (e) { 
                console.warn("Analysis error:", e); 
                toast("Analysis error. Using fallback values.", "warning"); 
            }
        }
        const d = { 
            age: metrics.age || "-- yrs", 
            gender: metrics.gender || "--", 
            pd: metrics.pd || "62 mm", 
            ipd: metrics.ipd || "62 mm", 
            npc: metrics.npc || "59 mm", 
            frameSize: metrics.frameSize || "Classic (142 mm)", 
            faceShape: metrics.faceShape || "Oval", 
            recommendation: metrics.recommendation || "Wayfarer / Aviator", 
            bridgeWidthMm: metrics.bridgeWidthMm || 18, 
            lensWidthMm: metrics.lensWidthMm || 52, 
            faceWidthMm: metrics.faceWidthMm || 142, 
            faceHeightMm: metrics.faceHeightMm || 188, 
            timestamp: metrics.timestamp, 
            imageBase64: base64 
        };
        Object.assign(scanData, d);
        $("out-pd").textContent = d.pd; 
        $("out-age").textContent = d.age; 
        $("out-gender").textContent = d.gender; 
        $("out-shape").textContent = d.faceShape; 
        $("out-size").textContent = d.frameSize; 
        $("out-rec").textContent = d.recommendation;
        if (resultThumb) { 
            const t = resultThumb.getContext("2d"); 
            resultThumb.width = 200; 
            resultThumb.height = 200; 
            t.drawImage(capCanvas, 0, 0, 200, 200); 
        }
        $("form-frame-size").textContent = d.frameSize; 
        $("form-frame-rec").textContent = d.recommendation; 
        $("form-ai-age").textContent = d.age; 
        $("form-pd").textContent = d.pd;
        cameraWrap.classList.remove("scanning"); 
        isAnalyzing = false; 
        captureHint.textContent = "tap to analyze"; 
        showScreen("results");
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * ğŸš€ GOOGLE SHEETS SUBMISSION (ONLY METHOD)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    async function sendToGoogleSheets(payload) {
        if (!CFG.googleSheetsUrl) {
            throw new Error("Google Sheets URL not configured");
        }
        
        const response = await fetch(CFG.googleSheetsUrl, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const text = await response.text();
            throw new Error(`Sheets API error: ${response.status} ${text}`);
        }

        const result = await response.json();
        if (!result.success) throw new Error("Sheets responded with error");
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * FORM SUBMIT HANDLER â€“ DIRECT TO GOOGLE SHEETS
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    finalForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = $("in-name").value.trim();
        const phone = $("in-phone").value.trim();

        if (!name) { 
            toast("Full name is required", "error"); 
            $("in-name").focus(); 
            return; 
        }
        if (!phone || !/^\d{10}$/.test(phone)) { 
            toast("Enter a valid 10-digit mobile number", "error"); 
            $("in-phone").focus(); 
            return; 
        }

        // Validate that the Google Sheets URL is set
        const configValid = validateGoogleSheetsUrl();
        if (!configValid) {
            toast("Google Sheets URL not configured. Please set CFG.googleSheetsUrl", "error");
            return;
        }

        const btn = $("btn-submit");
        const statusEl = $("form-status");
        btn.disabled = true;
        btn.innerHTML = '<span style="animation:spin 1s linear infinite;display:inline-block">â³</span> Saving...';
        statusEl.textContent = "Sending data to Google Sheets...";

        const payload = {
            name,
            phone,
            ageInput:    $("in-age-input").value.trim(),
            dob:         $("in-dob").value,
            genderInput: $("in-gender-input").value,
            address:     $("in-address").value.trim(),
            wardNo:      $("in-ward").value.trim(),
            boothNo:     $("in-booth").value.trim(),
            rightOD:     $("in-od").value.trim(),
            leftOS:      $("in-os").value.trim(),
            spherical:   $("in-sph").value.trim(),
            cylindrical: $("in-cyl").value.trim(),
            axis:        $("in-axis").value.trim(),
            prism:       $("in-prism").value.trim(),
            base:        $("in-base").value.trim(),
            power:       $("in-add").value.trim(),
            ...scanData
        };

        try {
            await sendToGoogleSheets(payload);
            
            statusEl.textContent = "âœ… Report saved to your Google Sheet!";
            statusEl.style.color = "#10b981";
            toast("Data sent to spreadsheet âœ…", "success");

            // Reset form after success
            setTimeout(() => {
                LensAI.closeForm();
                LensAI.resetCamera();
                finalForm.reset();
                statusEl.textContent = "ğŸ“ Data will be saved directly to your Google Sheet";
                statusEl.style.color = "";
            }, 2500);
        } catch (err) {
            console.error("Send error:", err);
            toast("Failed to send: " + err.message, "error");
            statusEl.textContent = "âŒ Send failed â€” check your Apps Script URL & deployment";
            statusEl.style.color = "#ef4444";
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸ“¤</span> Save to Google Sheet';
        }
    });

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * PUBLIC API (window.LensAI)
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    window.LensAI = {
        resetCamera() { 
            if (currentStream) currentStream.getTracks().forEach(t => t.enabled = true); 
            isAnalyzing = false; 
            disableCaptureButton(); 
            cameraWrap.className = "camera-wrap"; 
            showScreen("camera"); 
        },
        openForm() { 
            modalForm.classList.remove("hidden"); 
        },
        closeForm() { 
            modalForm.classList.add("hidden"); 
        },
        validateConfig: validateGoogleSheetsUrl
    };
    
    btnOpenForm.addEventListener("click", LensAI.openForm);

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     * BOOT
     * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    console.log("%cğŸš€ LensAI Pro â€“ Google Sheets Only", "font-size:20px;font-weight:bold;color:#3888ff");
    validateGoogleSheetsUrl();
    loadModels();
})();
</script>
</body>
</html>
